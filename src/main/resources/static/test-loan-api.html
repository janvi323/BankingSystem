<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Loan API</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { padding: 10px 20px; margin: 10px; }
        .results { background: #f5f5f5; padding: 15px; margin: 15px 0; border-radius: 5px; }
        .error { background: #ffe6e6; border: 1px solid #ff0000; }
        .success { background: #e6ffe6; border: 1px solid #00ff00; }
    </style>
</head>
<body>
    <h1>Loan API Test Page</h1>
    
    <div>
        <h3>Step 1: Login as Admin</h3>
        <button onclick="loginAsAdmin()">Login as Admin</button>
        <div id="loginResult" class="results"></div>
    </div>

    <div>
        <h3>Step 2: Get Current User</h3>
        <button onclick="getCurrentUser()">Check Current User</button>
        <div id="currentUserResult" class="results"></div>
    </div>

    <div>
        <h3>Step 3: Get All Loans</h3>
        <button onclick="getAllLoans()">Get All Loans</button>
        <div id="loansResult" class="results"></div>
    </div>

    <div>
        <h3>Step 4: Test Loan Approval (Enter Loan ID)</h3>
        <input type="number" id="loanId" placeholder="Enter Loan ID" value="1">
        <button onclick="testApproval()">Test Approve Loan</button>
        <button onclick="testRejection()">Test Reject Loan</button>
        <div id="approvalResult" class="results"></div>
    </div>

    <script>
        function loginAsAdmin() {
            // Try different possible admin credentials
            const possibleCredentials = [
                { email: 'admin@bank.com', password: 'admin123' },
                { email: 'admin@bank.com', password: 'password' },
                { email: 'admin@gmail.com', password: 'admin123' },
                { email: 'admin', password: 'admin' }
            ];

            // Try the first set of credentials
            const adminCredentials = possibleCredentials[0];

            fetch('/api/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(adminCredentials)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.text();
            })
            .then(data => {
                document.getElementById('loginResult').innerHTML = `<strong>Login Success:</strong> ${data}<br><strong>Credentials used:</strong> ${adminCredentials.email} / ${adminCredentials.password}`;
                document.getElementById('loginResult').className = 'results success';
            })
            .catch(error => {
                document.getElementById('loginResult').innerHTML = `
                    <strong>Login Failed:</strong> ${error.message}<br>
                    <strong>Tried:</strong> ${adminCredentials.email} / ${adminCredentials.password}<br>
                    <em>Note: You may need to create an admin user first. Check the test-data.sql file.</em>
                `;
                document.getElementById('loginResult').className = 'results error';
            });
        }

        function getCurrentUser() {
            fetch('/api/auth/current')
            .then(response => response.json())
            .then(data => {
                document.getElementById('currentUserResult').innerHTML = `<strong>Current User:</strong> ${JSON.stringify(data, null, 2)}`;
                document.getElementById('currentUserResult').className = 'results success';
            })
            .catch(error => {
                document.getElementById('currentUserResult').innerHTML = `<strong>Error:</strong> ${error.message}`;
                document.getElementById('currentUserResult').className = 'results error';
            });
        }

        function getAllLoans() {
            fetch('/api/loans/all')
            .then(response => response.json())
            .then(data => {
                document.getElementById('loansResult').innerHTML = `<strong>All Loans:</strong><pre>${JSON.stringify(data, null, 2)}</pre>`;
                document.getElementById('loansResult').className = 'results success';
            })
            .catch(error => {
                document.getElementById('loansResult').innerHTML = `<strong>Error:</strong> ${error.message}`;
                document.getElementById('loansResult').className = 'results error';
            });
        }

        function testApproval() {
            const loanId = document.getElementById('loanId').value;
            const comments = 'Test approval from API test page';

            fetch(`/api/loans/${loanId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    status: 'APPROVED',
                    comments: comments
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.text();
            })
            .then(data => {
                document.getElementById('approvalResult').innerHTML = `<strong>Approval Success:</strong> ${data}`;
                document.getElementById('approvalResult').className = 'results success';
            })
            .catch(error => {
                document.getElementById('approvalResult').innerHTML = `<strong>Approval Error:</strong> ${error.message}`;
                document.getElementById('approvalResult').className = 'results error';
            });
        }

        function testRejection() {
            const loanId = document.getElementById('loanId').value;
            const comments = 'Test rejection from API test page';

            fetch(`/api/loans/${loanId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    status: 'REJECTED',
                    comments: comments
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.text();
            })
            .then(data => {
                document.getElementById('approvalResult').innerHTML = `<strong>Rejection Success:</strong> ${data}`;
                document.getElementById('approvalResult').className = 'results success';
            })
            .catch(error => {
                document.getElementById('approvalResult').innerHTML = `<strong>Rejection Error:</strong> ${error.message}`;
                document.getElementById('approvalResult').className = 'results error';
            });
        }
    </script>
</body>
</html>